<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Introduction to Spark Structured Streaming - Part 9 : Processing Time Window</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Thoughts on technology, life and everything else.">
    <link rel="canonical" href="http://blog.madhukaraphatak.com/introduction-to-spark-structured-streaming-part-9">
     <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/app.css">
       
</head>


    <body>

    <header >
  <div class="wrap">
    <a class="site-title" href="/">Madhukar's Blog</a>  
    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">        
          <a class="page-link" href="http://www.madhukaraphatak.com">About me</a>                  
      </div>
    </nav>  
  </div>
</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">
 <header class="post-header">
  <h1>Introduction to Spark Structured Streaming - Part 9 : Processing Time Window</h1>
  <p class="meta">Sep 1, 2017</p>
  <div class="catagories">
    
    <a href="/categories/scala"><span class="category">scala</span></a>
    
    <a href="/categories/spark"><span class="category">spark</span></a>
    
    <a href="/categories/introduction-structured-streaming"><span class="category">introduction-structured-streaming</span></a>
    
  </div>
</header> 

<article class="post-content">
  <p>Structured Streaming is a new streaming API, introduced in spark 2.0, rethinks stream processing in spark land. It models stream
as an infinite table, rather than discrete collection of data. It’s a radical departure from models of other stream processing frameworks like
storm, beam, flink etc. Structured Streaming is the first API to build stream processing on top of SQL engine.</p>

<p>Structured Streaming was in alpha in 2.0 and 2.1. But with release 2.2 it has hit stable status. In next few releases,
it’s going to be de facto way of doing stream processing in spark. So it will be right time to make ourselves familiarise
with this new API.</p>

<p>In this series of posts, I will be discussing about the different aspects of the structured streaming API. I will be discussing about
new API’s, patterns and abstractions to solve common stream processing tasks.</p>

<p>This is the ninth post in the series. In this post, we discuss about processing time abstraction. You 
can read all the posts in the series <a href="/categories/introduction-structured-streaming">here</a>.</p>

<p>TL;DR You can access code on <a href="https://github.com/phatak-dev/spark2.0-examples/tree/master/src/main/scala/com/madhukaraphatak/examples/sparktwo/streaming">github</a>.</p>

<h2 id="processing-time-abstraction">Processing Time Abstraction</h2>

<p>In last <a href="/introduction-to-spark-structured-streaming-part-8/">post</a> we discussed about the different time abstractions. One of those abstractions were processing time. As name signifies, processing time is the time tracked by processing engine regarding when data was arrived for processing. This is same as time definition of older DStream API. In this abstraction of time, time passed is signified by the central clock maintained at the driver.</p>

<p>In this post, we will discuss how to define a window on processing time. This allows us to see how we can mimic the DStream window API functionality in structured streaming API.</p>

<h2 id="windowed-wordcount-using-processing-time">Windowed WordCount using Processing Time</h2>

<p>The below are the steps to implement windowed word count using processing time abstraction.</p>

<h3 id="reading-data-from-socket">Reading Data From Socket</h3>

<p>The below code is to read the data from socket.</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">socketStreamDf</span> <span class="k">=</span> <span class="n">sparkSession</span><span class="o">.</span><span class="n">readStream</span>
  <span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">"socket"</span><span class="o">)</span>
  <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">"host"</span><span class="o">,</span> <span class="s">"localhost"</span><span class="o">)</span>
  <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">"port"</span><span class="o">,</span> <span class="mi">50050</span><span class="o">)</span>
  <span class="o">.</span><span class="n">load</span><span class="o">()</span></code></pre></div>

<h3 id="adding-the-time-column">Adding the Time Column</h3>

<p>To define a window in structured streaming, we need to have a column in dataframe of the type <em>Timestamp</em>. As we are working with processing time,
we will use <em>current_timestamp()</em> function of spark SQL to add processing time to our data.</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">currentTimeDf</span> <span class="k">=</span> <span class="n">socketStreamDf</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">"processingTime"</span><span class="o">,</span><span class="n">current_timestamp</span><span class="o">())</span></code></pre></div>

<p>In above code, we are adding a column named <em>processingTime</em> which captures the current time of the processing engine.</p>

<h3 id="extracting-words">Extracting Words</h3>

<p>The below code extracts the words from socket and creates words with timestamp.</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">sparkSession.implicits._</span>
<span class="k">val</span> <span class="n">socketDs</span> <span class="k">=</span> <span class="n">currentTimeDf</span><span class="o">.</span><span class="n">as</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Timestamp</span><span class="o">)]</span>
<span class="k">val</span> <span class="n">wordsDs</span> <span class="k">=</span> <span class="n">socketDs</span>
  <span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="n">line</span> <span class="k">=&gt;</span> <span class="n">line</span><span class="o">.</span><span class="n">_1</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">" "</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">word</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">word</span><span class="o">,</span> <span class="n">line</span><span class="o">.</span><span class="n">_2</span><span class="o">)))</span>
  <span class="o">.</span><span class="n">toDF</span><span class="o">(</span><span class="s">"word"</span><span class="o">,</span> <span class="s">"processingTime"</span><span class="o">)</span></code></pre></div>

<h3 id="defining-window">Defining Window</h3>

<p>Once we have words, we define a tumbling window which aggregates data for last 15 seconds.</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">windowedCount</span> <span class="k">=</span> <span class="n">wordsDs</span>
  <span class="o">.</span><span class="n">groupBy</span><span class="o">(</span>
    <span class="n">window</span><span class="o">(</span><span class="n">$</span><span class="s">"processingTime"</span><span class="o">,</span> <span class="s">"15 seconds"</span><span class="o">)</span>
  <span class="o">)</span>
  <span class="o">.</span><span class="n">count</span><span class="o">()</span>
  <span class="o">.</span><span class="n">orderBy</span><span class="o">(</span><span class="s">"window"</span><span class="o">)</span></code></pre></div>

<p>In above code, we define window as part of groupby. We group the records that we received in last 15 seconds.</p>

<p>Window API takes below parameters</p>

<ul>
  <li>
    <p>Time Column - Name of the time column. In our example it’s <em>processingTime</em>.</p>
  </li>
  <li>
    <p>Window Time - How long is the window. In our example it’s <em>15 seconds</em> .</p>
  </li>
  <li>
    <p>Slide Time - An optional parameter to specify the sliding time. As we are implementing tumbling window, we have skipped it.</p>
  </li>
</ul>

<p>Once we do groupBy, we do the count and sort by <em>window</em> to observe the results.</p>

<h3 id="query">Query</h3>

<p>Once we have defined the window, we can setup the execution using query.</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">query</span> <span class="k">=</span>
  <span class="n">windowedCount</span><span class="o">.</span><span class="n">writeStream</span>
    <span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">"console"</span><span class="o">)</span>
    <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">"truncate"</span><span class="o">,</span><span class="s">"false"</span><span class="o">)</span>
    <span class="o">.</span><span class="n">outputMode</span><span class="o">(</span><span class="nc">OutputMode</span><span class="o">.</span><span class="nc">Complete</span><span class="o">())</span>

<span class="n">query</span><span class="o">.</span><span class="n">start</span><span class="o">().</span><span class="n">awaitTermination</span><span class="o">()</span></code></pre></div>

<p>You access complete code on <a href="https://github.com/phatak-dev/spark2.0-examples/blob/master/src/main/scala/com/madhukaraphatak/examples/sparktwo/streaming/ProcessingTimeWindow.scala">github</a>.</p>

<h2 id="output">Output</h2>

<p>When we run the example, we will observe the below results</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">+---------------------------------------------+-----+
|window                                       |count|
+---------------------------------------------+-----+
|[2017-09-01 12:44:00.0,2017-09-01 12:44:15.0]|2    |
|[2017-09-01 12:44:15.0,2017-09-01 12:44:30.0]|8    |
+---------------------------------------------+-----+</code></pre></div>

<p>As you can observe from the above output, we have count for each fifteen second interval. This makes sure that our window function is working.</p>

<p>In upcoming posts, we will discuss about other time abstractions.</p>

</article>
<div class="related">
  <h2>Related posts</h2>
  <ul>
    
             
    
    <li>    
     <span class="post-date">14 Jun 2019</span>
     &raquo; <a href="/migrate-spark-datasource-2.4">Migrating to Spark 2.4 Data Source API</a>    
   </li>           
         

            
    
    <li>    
     <span class="post-date">06 Jun 2019</span>
     &raquo; <a href="/multi-column-feature-transformation-spark-ml">Multiple Column Feature Transformations in Spark ML</a>    
   </li>           
         

            
    
    <li>    
     <span class="post-date">27 May 2019</span>
     &raquo; <a href="/parallel-cross-validation">Parallel Cross Validation in Spark</a>    
   </li>           
         

   
   
             
    
    <li>    
     <span class="post-date">14 Jun 2019</span>
     &raquo; <a href="/migrate-spark-datasource-2.4">Migrating to Spark 2.4 Data Source API</a>    
   </li>           
         

            
    
    <li>    
     <span class="post-date">06 Jun 2019</span>
     &raquo; <a href="/multi-column-feature-transformation-spark-ml">Multiple Column Feature Transformations in Spark ML</a>    
   </li>           
         

            
    
    <li>    
     <span class="post-date">27 May 2019</span>
     &raquo; <a href="/parallel-cross-validation">Parallel Cross Validation in Spark</a>    
   </li>           
         

   
   
 </ul>


 
<!--     
    <div id="disqus_thread" style="padding-top:4%;"></div>
     <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'personalblogmadhukar'; // required: replace example with your forum shortname
        var disqus_developer = 1;

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
   
</div> -->

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">   
    <div class="footer-col-1 column">
      <ul>
        <li>
          <a href="https://github.com/phatak-dev">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username">phatak-dev</span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/madhukaraphatak">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username">madhukaraphatak</span>
          </a>
        </li>
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">Thoughts on technology, life and everything else.</p>
    </div>

    <div style="float:right;">
      <a href="/feed.xml"><img src="/images/rss.png">
    </div>



  </div>

</footer>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-52311191-1', 'auto');
  ga('send', 'pageview');

</script>

    </body>
</html>